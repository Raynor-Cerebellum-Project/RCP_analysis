nChannelsNpxl = questdlg("How many channels are in the neural data?", "nChannelsNpxl", "64", "128", "other", "other");

if (nChannelsNpxl == "128") 
    neuropixel_index = [    18, 19, 20, 21, 22, 23, 24, 25, ...
        26, 27, 29, 17, 2,  32, 1,  30, ...
        31, 39, 3,  36, 38, 28, 35, 37, ...
        4,  34, 16, 33, 15, 14, 13, 12, ...
        11, 10, 9,  8,  7,  6,  5,  63, ...
        59, 56, 64, 58, 55, 40, 57, 54, ...
        41, 60, 53, 43, 61, 52, 44, 62, ...
        51, 42, 47, 50, 45, 48, 49, 46, ...
        65, 96, 69, 66, 95, 68, 67, 94, ...
        70, 83, 93, 72, 84, 92, 71, 85, ...
        91, 73, 88, 90, 81, 87, 89, 82, ...
        86, 108, 107, 106,105,104,103,102,...
        101,100,99, 98, 80, 97, 79, 109,...
        76, 78, 117,75, 77, 110,74, 114,...
   	    115,112,113,111,128,116,118,119,...
        120,121,122,123,124,125,126,127];
else
    if (nChannelsNpxl == "64")
        neuropixel_index = [1, 2, 3, 4, 5, 6, 7, 8, ...
            9, 10, 11, 12, 13,  14, 15, 16, ...
            17, 18, 19, 20, 21, 22, 23, 24, ...
            25,  26, 27, 28, 29, 30, 31, 32, ...
            33, 34, 35, 36, 37, 38, 39, 40, ...
            41, 42, 43, 44, 45, 46, 47, 48, ...
            49, 50, 51, 52, 53, 54, 55, 56, ...
            57, 58, 59, 60, 61, 62, 63, 64];
    else 
        error("no channel number entered");
    end
end

% neuropixel_index = [    18, 19, 20, 21, 22, 23, 24, 25, ...
%     26, 27, 29, 17, 2,  32, 1,  30, ...
%     31, 55, 3,  52, 54, 28, 51, 53, ...
%     4,  50, 16, 49, 15, 14, 13, 12, ...
%     11, 10, 9,  8,  7,  6,  5,  47, ...
%     43, 40, 48, 42, 39, 56, 41, 38, ...
%     57, 44, 37, 59, 45, 36, 60, 46, ...
%     35, 58, 63, 34, 61, 64, 33, 62, ...
%     81, 80, 85, 82, 79, 84, 83, 78, ...
%     86, 67, 77, 88, 68, 76, 87, 69, ...
%     75, 89, 72, 74, 65, 71, 73, 66, ...
%     70, 108, 107, 106, 105,104,103,102,...
%     101,100,99, 98, 96, 97, 95, 109,...
%     92, 94, 117,91, 93, 110,90, 114,...
%     115,112,113,111,128,116,118,119,...
%     120,121,122,123,124,125,126,127];

F = dir();
F = struct2cell(F);
F = F(1,3:end);
F = F(contains(F,'.rhs'));
intan_files = sort(F);

session_triger = [];
fileID = fopen('all_files.bin','w');
for i = neuropixel_index
    Data.ChannelList{i} = strcat('Ch',num2str(i));
    Data.(Data.ChannelList{i}) = zeros();
end

neural_data = [];
Stim_data = [];
for intan_file_index = 1:length(intan_files)
    intan_file = intan_files{intan_file_index};
    disp(['Processing Intan file: ' intan_file])
    
    read_Intan_RHS2000_file(intan_file);  % populates amplifier_data and board_adc_data

    fwrite(fileID, int16(amplifier_data(neuropixel_index,:)), 'int16');  % optional raw binary write
    
    session_triger = [session_triger board_adc_data(1:2,:)];  % if needed

    % Append neural data
    if nChannelsNpxl == "128"
        neural_data = [neural_data, amplifier_data(1:128,:)];  % concatenate across time

        % Append stim data from desired ADC channel (e.g., channel 3)
        Stim_data = [Stim_data, stim_data(1:128,:)];

        % Optional: populate Data struct
        for i = 1:128
            analog = amplifier_data(i,:);
            Data.(strcat('Ch', num2str(i))) = [Data.(strcat('Ch', num2str(i))) analog];
        end
    elseif nChannelsNpxl == "64"
        neural_data = [neural_data, amplifier_data(1:64,:)];

        % Populate downsampled version into Data
        for i = neuropixel_index
            analog = amplifier_data(i,:);
            analog = downsample(analog, 30, 10);  % optional
            Data.(Data.ChannelList{i}) = [Data.(Data.ChannelList{i}) analog];
        end
    end
end

Data.Neural = neural_data;
Data.Stim = Stim_data;
fclose(fileID);
save('session_triger.mat','session_triger','-v7.3')    
save('neural_data.mat','neural_data','-v7.3')
save("stim_data.mat","Stim_data","-v7.3")